generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE")
}

model User {
  id                  String          @id @default(cuid())
  email               String          @unique
  password            String
  username            String          @unique
  phone               String          @unique
  chats               Chat[]          @relation("ChatParticipants")
  sentMessages        Messages[]      @relation("SenderMessages")
  receivedMessages    Messages[]      @relation("RecipientMessages")
  sentFriendships     Friendship[]    @relation("FriendshipSender")
  receivedFriendships Friendship[]    @relation("FriendshipReceiver")
  ownedGroups         Group[]         @relation("OwnerGroups")
  groupMembers        GroupMember[]   @relation("UserGroups")
  groupMessages       GroupMessage[] @relation("GroupMessages")
}

model Friendship {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  status     String   @default("pending")
  createdAt  DateTime @default(now())
  sender     User     @relation("FriendshipSender", fields: [senderId], references: [id])
  receiver   User     @relation("FriendshipReceiver", fields: [receiverId], references: [id])
}

model Chat {
  id           String     @id @default(cuid())
  participants User[]     @relation("ChatParticipants")
  messages     Messages[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Messages {
  id          String   @id @default(cuid())
  content     String
  senderId    String
  chatId      String
  recipientId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chat      Chat @relation(fields: [chatId], references: [id])
  sender    User @relation("SenderMessages", fields: [senderId], references: [id])
  recipient User @relation("RecipientMessages", fields: [recipientId], references: [id])
}

model Otp {
  id        String   @id @default(cuid())
  otp       String
  email     String
  phone     String
  createdAt DateTime @default(now())
  expiresAt DateTime
  updatedAt DateTime @updatedAt
}

model Group {
  id           String          @id @default(cuid())
  groupName    String
  githubRepo   String
  ownerName    String
  githubAccessToken String
  ownerId      String
  createdAt    DateTime        @default(now())
  owner        User?           @relation("OwnerGroups", fields: [ownerId], references: [id])
  members      GroupMember[]   @relation("GroupToMembers")
  groupMessage GroupMessage[] @relation("GroupMessage")
}

model GroupMember {
  id      String    @id @default(cuid())
  groupId String
  userId  String
  group   Group     @relation("GroupToMembers", fields: [groupId], references: [id])
  user    User      @relation("UserGroups", fields: [userId], references: [id])
  role    GroupRole @default(MEMBER)

  @@index([groupId])
  @@index([userId])
}

model Invite {
  id        String   @id @default(cuid())
  phone     String   @unique
  groupId   String
  status    String   @default("pending")
  createdAt DateTime

  @@unique([phone, groupId])
}

model GroupMessage {
  id         String   @id @default(cuid())
  groupId    String
  senderId   String
  senderName String?
  message    String
 createdAt DateTime @default(now())
  user       User     @relation("GroupMessages", fields: [senderId], references: [id])
  group      Group    @relation("GroupMessage", fields: [groupId], references: [id])
}

enum GroupRole {
  ADMIN
  MEMBER
}
